---
layout: post
title: 'mysql全连接'
date: 2023-03-02
description: 'mysql全连接'
tags: '技术'
--- 

截止当前最新版本 8.0.19，MySQL 尚未支持 Full Join（全外连接），但我们可以使用其它方式实现 Full Join 的效果。

理论上，全外连接是左外连接和右外连接的组合。完整的外部连接包括联接表中的所有行，无论另一个表是否具有匹配的行。

如果联接表中的行不匹配，则全外连接的结果集将为缺少匹配行的表的每一列设置为 NULL 。对于匹配的行，返回它们关联的结果。

我们来看在其他支持 Full Join 语法的关系数据库的执行情况，有示例表`emp`和`dept`（这两个表的表结构及数据放在文末）。经过观察，我们可知`emp`表的 7259 编号的员工缺少部门编号，`dept`表的编号未为 40 的部门在`emp`表中没有对应记录。

<div align=center><img src="https://s1.ax1x.com/2023/03/03/ppku71U.png"></div>
<div align=center>图1 emp 表</div>



<div align=center><img src="https://s1.ax1x.com/2023/03/03/ppkubX4.md.png"></div>
<div align=center>图2 dept 表</div>

执行下面的 SQL 脚本，输出图 3 的结果。

```sql
SELECT * FROM emp e
FULL JOIN dept d ON d.deptno = e.deptno
```
<div align=center><img src="https://s1.ax1x.com/2023/03/03/ppkuHcF.md.png"></div>
<div align=center>图3 全连接的输出结果</div>

在 MySQL 里，我们通过以下两种方式实现 Full Join 的效果。当然了，还有其他方式也可以实现这效果，就不一一列举了。

**方式一：两个 Join 和一个 Union**

在这种情况下，这可以提供理想的结果，但并非在所有情况下都正确。

如果`emp`表或者`dept`表存在重复记录，使用这种方式将会移除重复记录。下面我们将通过`UNION ALL`改写这段 SQL，使之完全达到`FULL JOIN`的效果。

**方式二：UNOIN ALL 和排除连接**
```sql
SELECT * FROM EMP E
LEFT JOIN DEPT D ON D.DEPTNO = E.DEPTNO
UNION ALL
SELECT * FROM EMP E
RIGHT JOIN DEPT D ON D.DEPTNO = E.DEPTNO
WHERE E.DEPTNO IS NULL
```

这样可以保留同一个表中重复的行，并且保证两个子查询不会产生重复记录。

由于不需要排序和删除重复项，因此对于大型结果集，这可能会大大提高效率。

**结语**
在工作中，我们用到`full join`的场景可能比较少。那么在什么时候你会想到使用`full join`呢？

下面说一下我在工作中遇到使用`full join`场景的经历。

对于大型的仓库会有进行库存盘点，首先指定盘点计划，然后仓库人员进行盘点并记录盘点实际数量，最后展示出盘点结果差异。

这里用到三个表盘点计划表，盘点实际表，和盘点结果差异表。实际盘点可能会有很多的情况，比如计划盘点在库区ABC中有产品A，而实际盘点的时候发现在BCD库存中有产品A。我们做盘点结果差异的时候需要把所有包含产品A的库区都插入到盘点结果差异表中。这时候使用`full join`会解决大部分问题。

以上，至此
